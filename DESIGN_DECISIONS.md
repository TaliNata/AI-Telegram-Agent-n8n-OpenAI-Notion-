# Этот документ описывает ключевые архитектурные и продуктовые решения, принятые при разработке AI-агента, а также причины этих решений с точки зрения production-эксплуатации.

## 1. Фиксированное временное окно: «прошлая неделя»

### Что сделано
Все сценарии агента (новости, идеи, отчёты, универсальный дайджест) обрабатывают данные за предыдущую календарную неделю.

### Зачем это сделано
Обеспечить детерминированность результатов
Один и тот же запуск всегда даёт одинаковый результат для одного периода.
Согласовать ручные и плановые запуски
Cron-запуск и команда из Telegram работают с одинаковым диапазоном данных.
Избежать дубликатов и пересечений данных
Каждая неделя обрабатывается ровно один раз.

### Почему выбран именно этот подход
Использование относительных периодов (например, «последние 7 дней») приводит к:

дрейфу данных между запусками,
невозможности сравнивать отчёты,
несоответствию между ручным и автоматическим режимами.

Фиксированное окно («прошлая неделя») решает эти проблемы и упрощает аналитику и логирование.

## 2. Production-совместимость с Cron

### Что сделано
Агент спроектирован так, чтобы одинаково корректно работать:
при запуске по расписанию (Cron),
при ручном вызове пользователем.

### Зачем это сделано
Минимизировать расхождения между автоматическим и ручным режимами.
Упростить поддержку и отладку.
Исключить скрытые состояния и временные зависимости.

### Почему это важно
В production-среде сценарии должны быть:
повторяемыми,
предсказуемыми,
независимыми от времени запуска.

## 3. Контроль нагрузки на LLM и API

### Что сделано
Временное окно ограничено одной неделей, что:
стабилизирует количество обрабатываемых записей,
ограничивает размер prompt,
предотвращает переполнение контекста.

### Зачем это сделано
Контроль стоимости LLM-запросов.
Снижение риска ошибок context_length_exceeded.
Предсказуемое время ответа.

### Почему это важно
LLM-агенты в production должны учитывать:
стоимость токенов,
лимиты API,
стабильность времени ответа.

## 4. Единый UX-паттерн для всех сценариев

### Что сделано
Все команды используют одинаковую временную модель:
«Новости за прошлую неделю»
«Идеи за прошлую неделю»
«Отчёты за прошлую неделю»
Универсальный дайджест за прошлую неделю

### Зачем это сделано
Сформировать понятный пользовательский ритм.
Упростить восприятие и сравнение отчётов.
Снизить когнитивную нагрузку на пользователя.

### Почему это масштабируемо
При добавлении новых сценариев:
меняется тип обработки,
но сохраняется временной контракт.
Это позволяет расширять функциональность без изменения базовой логики.

## 5. Возможные улучшения (не реализованы сознательно)

Следующие улучшения возможны, но не включены в базовую реализацию:
параметризация периода (/news week | month);
fallback к значению по умолчанию при ошибке;
пользовательские временные окна.

Они не реализованы, чтобы:
сохранить простоту,
избежать усложнения UX,
не вводить дополнительные риски на MVP-этапе.

## 6. Использование Notion для логирования результатов (Create Database Page)

### Что сделано
Результаты работы AI-агента сохраняются в Notion через операцию Create Database Page.
Для каждого запуска создаётся отдельная запись с итогами обработки.

### Зачем это сделано
Фиксация результатов работы агента
Каждый отчёт сохраняется независимо от Telegram, что исключает потерю данных.
Историчность и аудит
Notion используется как журнал выполненных операций:
дата запуска,
тип сценария,
количество обработанных записей,
статус выполнения.

Отделение логики обработки от канала доставки
Telegram используется только как интерфейс доставки,
Notion — как источник истины (single source of truth).

### Почему выбран именно Notion
Удобная структура данных (database → properties).
Поддержка API для создания и обновления записей.
Возможность ручного просмотра, фильтрации и аналитики без дополнительного UI.
Низкий порог входа для не-технических пользователей.

### Почему используется именно Create Database Page

Каждое выполнение агента — отдельный immutable-результат.
Нет перезаписи данных и потери истории.
Упрощён анализ, сравнение периодов и отладка.
В production-контексте это соответствует паттерну append-only logging.

### Как это связано с Cron и временными окнами

Фиксированное временное окно («прошлая неделя») + отдельная запись в Notion:
исключают дублирование отчётов,
обеспечивают соответствие «один период → одна запись»,
позволяют безопасно перезапускать workflow.

### Почему это важно для production

Устойчивость к сбоям Telegram или LLM.
Возможность повторной отправки отчёта без перерасчёта.
Прозрачность работы агента для команды и заказчика.

### Возможные расширения
статус выполнения (success / error);
сохранение ошибок и stack trace;
связь с Error Trigger;
базовая аналитика (по типам сценариев, периодам).

## Итог

Выбор фиксированного временного окна «прошлая неделя» — это осознанное архитектурное решение, направленное на:
стабильность,
воспроизводимость,
контроль стоимости,
production-готовность AI-агента.

Использование Notion с Create Database Page превращает AI-агента из «бота, который отвечает»
в production-систему с историей, контролем и наблюдаемостью.
